#!/usr/bin/env ruby

require 'optparse'
require 'methadone'
require 'overlord_quote.rb'

class App
  DEFAULT_AFTER_SENTENCES = 5

  include Methadone::Main
  include Methadone::CLILogging
  include OverlordQuote

  main do |search_term|
    after_sentences = options.fetch(:A) { DEFAULT_AFTER_SENTENCES }

    volume = ENV["OVERLORD_TEXT"]

    @sentences = Sentences.new volume
    @matching_sentences = MatchingSentences.new search_term, @sentences
    @random_matching_sentence = @matching_sentences.random_sentence

    puts "Total matching sentences: #{@matching_sentences.size}"
    puts "Matching sentence id: #{@random_matching_sentence.id} (out of #{@matching_sentences.size})"
    puts

    puts random_quote(after_sentences)
  end

  # supplemental methods here

  def self.random_quote(after_sentences)
    @sentences.quote(
      starting_sentence: @random_matching_sentence.orig_sentence,
      after_sentences: after_sentences)
  end

  # Declare command-line interface here

  description "Print a random quote from Overlord light novel"

  arg :search_term, :optional
  on("-A", "--after-context=NUM", Integer,
          "Print NUM sentences after the matching sentence (DEFAULT: #{DEFAULT_AFTER_SENTENCES})")

  # Accept flags via:
  # on("--flag VAL","Some flag")
  # options[flag] will contain VAL
  #
  # Specify switches via:
  # on("--[no-]switch","Some switch")
  #
  # Or, just call OptionParser methods on opts
  #
  # Require an argument
  # arg :some_arg 
  #
  # # Make an argument optional
  # arg :optional_arg, :optional

  version OverlordQuote::VERSION

  use_log_level_option :toggle_debug_on_signal => 'USR1'

  go!
end
